# Updates README with count of unique languages used across all public repos
# Run: weekly (Sunday 00:00 UTC) or manually (workflow_dispatch)

name: Update languages count

on:
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.ref }}

      - name: Get languages count
        id: langs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
        run: |
          python3 << 'SCRIPT'
          import os, urllib.request, json
          token = os.environ.get("GITHUB_TOKEN")
          owner = os.environ.get("OWNER")
          headers = {"Authorization": f"token {token}", "Accept": "application/vnd.github.v3+json"}
          # Get all public repos (paginate)
          repos = []
          page = 1
          while True:
              req = urllib.request.Request(
                  f"https://api.github.com/users/{owner}/repos?per_page=100&page={page}&type=owner",
                  headers=headers
              )
              with urllib.request.urlopen(req) as r:
                  data = json.loads(r.read().decode())
              if not data:
                  break
              repos.extend([r["name"] for r in data])
              if len(data) < 100:
                  break
              page += 1
          # Get languages for each repo
          all_langs = set()
          for repo in repos:
              try:
                  req = urllib.request.Request(
                      f"https://api.github.com/repos/{owner}/{repo}/languages",
                      headers=headers
                  )
                  with urllib.request.urlopen(req, timeout=10) as r:
                      all_langs.update(json.loads(r.read().decode()).keys())
              except Exception:
                  pass
          count = len(all_langs)
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"count={count}\n")
          print(f"Unique languages across all repos: {count}")
          print(f"Languages: {', '.join(sorted(all_langs))}")
          SCRIPT

      - name: Update README
        run: |
          COUNT="${{ steps.langs.outputs.count }}"
          if [ ! -f README.md ]; then
            echo "README.md not found"
            exit 1
          fi
          # Replace placeholder or any previous count in the badge URL
          sed -i.bak "s|Languages%20used%20(all%20repos)-REPLACE_LANG_COUNT-blue|Languages%20used%20(all%20repos)-${COUNT}-blue|g" README.md
          sed -i.bak "s|Languages%20used%20(all%20repos)-[0-9]*-blue|Languages%20used%20(all%20repos)-${COUNT}-blue|g" README.md
          rm -f README.md.bak
          echo "Updated languages count to: $COUNT"
          grep "Languages%20used" README.md || true

      - name: Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git status
          if git diff --quiet README.md; then
            echo "No change in README.md"
          else
            git add README.md
            git commit -m "chore: update languages count in README"
            git push origin HEAD
          fi
